### javascript 事件循环机制

#####浏览器内核

浏览器进程---包含以下线程： 

* ###### GUI 渲染线程

  - 主要负责页面的渲染，解析HTML、CSS，构建DOM树，布局和绘制等。
  - 当界面需要重绘或者由于某种操作引发回流时，将执行该线程。
  - 该线程与JS引擎线程互斥，当执行JS引擎线程时，GUI渲染会被挂起，当任务队列空闲时，JS引擎才会去执行GUI渲染

* ##### JS引擎线程

  * 该线程当然是主要负责处理 `JavaScript`脚本，执行代码。
  * 也是主要负责执行准备好待执行的事件，即定时器计数结束，或者异步请求成功并正确返回时，将依次进入任务队列，等待 `JS引擎线程`的执行。
  * 当然，该线程与 `GUI渲染线程`互斥，当 `JS引擎线程`执行 `JavaScript`脚本时间过长，将导致页面渲染的阻塞

* ##### 事件触发线程

  * 主要负责将准备好的事件交给 `JS引擎线程`执行。
  * 比如 `setTimeout`定时器计数结束， `ajax`等异步请求成功并触发回调函数，或者用户触发点击事件时，该线程会将整装待发的事件依次加入到任务队列的队尾，等待 `JS引擎线程`的执行

* ##### 定时器触发线程

  * 顾名思义，负责执行异步定时器一类的函数的线程，如： `setTimeout，setInterval`。
  * 主线程依次执行代码时，遇到定时器，会将定时器交给该线程处理，当计数完毕后，事件触发线程会将计数完毕后的事件加入到任务队列的尾部，等待JS引擎线程执行。

* ##### HTTP 请求线程

  * 顾名思义，负责执行异步请求一类的函数的线程，如： `Promise，axios，ajax`等。
  * 主线程依次执行代码时，遇到异步请求，会将函数交给该线程处理，当监听到状态码变更，如果有回调函数，事件触发线程会将回调函数加入到任务队列的尾部，等待JS引擎线程执行。



#### 同步任务 和异步任务

* 同步任务： 立即执行的任务；
* 异步任务：不会立即执行的事件任务。 异步任务包括宏任务 和微任务；

常见的异步操作： 

* Ajax

* DOM 的时间操作；

* setTimeOut

* Promise的 then 方法

* Node 的读取文件

  ![image-20200305161733705](/Users/tangqi/Library/Application Support/typora-user-images/image-20200305161733705.png)

#### 宏任务和微任务

- 宏任务：script，setTimeout，setImmediate，promise中的executor
- 微任务：promise.then，process.nextTick     -----》 process.nextTick`优先级高于`Promise.then

当一个异步任务入栈时，主线程会先判断该任务为异步任务，并把该任务交给异步处理模块处理了；当异步处理没块处理完达到触发条件的时候，根据任务的类型，将回调函数压入任务队列；

* 如果是宏任务。则新增一个宏任务队列，任务队列中的宏任务可以有多个来源；
* 如果是微任务，则直接压入微任务队列；

所以上图的任务队列可以继续细化一下：

![image-20200311161549232](/Users/tangqi/Library/Application Support/typora-user-images/image-20200311161549232.png)

